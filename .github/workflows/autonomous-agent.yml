name: Autonomous Agent Execution

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to work on'
        required: true
        type: number
      task_type:
        description: 'Type of task (fix-bug, add-feature, refactor)'
        required: true
        type: choice
        options:
          - fix-bug
          - add-feature
          - refactor
      execution_mode:
        description: 'Execution mode'
        required: false
        type: choice
        default: 'auto'
        options:
          - auto
          - guided
          - safe
      approval_level:
        description: 'Approval level'
        required: false
        type: choice
        default: 'critical'
        options:
          - auto
          - critical
          - all

  issue_comment:
    types: [created]

  issues:
    types: [labeled]

jobs:
  validate:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'issues' && github.event.label.name == 'ü§ñagent-execute') ||
      (github.event_name == 'issue_comment' && 
       github.event.issue.pull_request == null && 
       (contains(github.event.comment.body, '/agent') || 
        contains(github.event.comment.body, '@miyabi')))
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      issue_number: ${{ steps.extract.outputs.issue_number }}
      task_type: ${{ steps.extract.outputs.task_type }}
    steps:
      - name: Check execution conditions
        id: check
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "should_run=true" >> "$GITHUB_OUTPUT"
      
      - name: Extract parameters
        id: extract
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "issue_number=${{ inputs.issue_number }}" >> "$GITHUB_OUTPUT"
            echo "task_type=${{ inputs.task_type }}" >> "$GITHUB_OUTPUT"
          else
            echo "issue_number=${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"
            echo "task_type=add-feature" >> "$GITHUB_OUTPUT"
          fi

  execute:
    needs: validate
    if: needs.validate.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    env:
      ISSUE_NUMBER: ${{ needs.validate.outputs.issue_number }}
      TASK_TYPE: ${{ needs.validate.outputs.task_type }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run typecheck
        run: npm run typecheck
        continue-on-error: true
        
      - name: Setup Miyabi
        run: |
          # Ensure Miyabi is available
          npx miyabi --version || npm install -g miyabi
          
      - name: Execute agents
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Executing agents for issue #${{ env.ISSUE_NUMBER }}"
          # Execute Miyabi without ANTHROPIC_API_KEY
          npx miyabi run \
            --task ${{ env.TASK_TYPE }} \
            --issue ${{ env.ISSUE_NUMBER }} \
            --mode auto \
            --approval critical \
            --verbose
        timeout-minutes: 30
        
      - name: Comment on issue
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}';
            const emoji = status === 'success' ? '‚úÖ' : '‚ùå';
            const message = status === 'success' 
              ? 'Agent execution completed successfully!' 
              : 'Agent execution failed. Check the logs for details.';
            
            github.rest.issues.createComment({
              issue_number: ${{ env.ISSUE_NUMBER }},
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${emoji} ${message}\n\n[View workflow run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
            });