# Claude Agent Skills 完全ガイド

このガイドは、Claudeの**Agent Skills**（エージェントスキル）を理解し、作成し、活用するための包括的なマニュアルです。公式ドキュメント、ベストプラクティス、およびCookbookからの情報を基に、実践的な知識を詳細にまとめています。

## 目次

1. [Agent Skillsとは](#1-agent-skillsとは)
2. [アーキテクチャと段階的開示](#2-アーキテクチャと段階的開示)
3. [スキルの作成手順](#3-スキルの作成手順)
4. [ベストプラクティス](#4-ベストプラクティス)
5. [コーディングとスクリプト](#5-コーディングとスクリプト)
6. [APIとSDKでの使用方法](#6-apiとsdkでの使用方法)
7. [テストと評価](#7-テストと評価)
8. [トラブルシューティング](#8-トラブルシューティング)
9. [効果的なスキルのチェックリスト](#9-効果的なスキルのチェックリスト)

---

## 1. Agent Skillsとは

Agent Skillsは、Claudeの機能を拡張するための専門的な「専門知識パッケージ」です。指示（プロンプト）、実行可能なコード、およびリソースファイルで構成され、Claudeが特定のタスクを自律的に実行できるようにします。

**主な用途:**
- **ドキュメント作成**: Word, Excel, PowerPoint, PDFの作成と編集
- **データ分析**: 複雑なデータ処理、可視化、レポート生成
- **業務効率化**: 企業固有のワークフローやブランドガイドラインの適用
- **自動化**: ドメイン知識を活用したビジネスプロセスの自動化

---

## 2. アーキテクチャと段階的開示

Agent Skillsの設計における中心的な概念は**Progressive Disclosure（段階的開示）**です。これは、すべての情報を一度に読み込むのではなく、必要なときに必要な情報だけをClaudeに提供する仕組みです。

### 仕組み
1. **発見 (Discovery)**:
   - 起動時、Claudeは各スキルの**メタデータ**（`name`と`description`）のみを読み込みます。
   - これにより、トークン消費を抑えつつ、数百のスキルから適切なものを選択できます。

2. **読み込み (Loading)**:
   - ユーザーのリクエストに関連するスキルが見つかった場合のみ、そのスキルのメインファイル（`SKILL.md`）を読み込みます。

3. **実行と探索 (Execution & Exploration)**:
   - `SKILL.md`内の指示に従い、必要に応じて追加の参照ファイル（`reference.md`など）やスクリプトを読み込んだり実行したりします。

このアーキテクチャにより、大規模なドキュメントやデータセットを含めても、実際にアクセスされるまでコンテキストウィンドウ（トークン）を消費しません。

---

## 3. スキルの作成手順

スキルはディレクトリとして構成され、必須の`SKILL.md`を含みます。

### ディレクトリ構造の例
```
my-skill/
├── SKILL.md           # 必須: メインの指示とメタデータ
├── pages/             # オプション: 追加のドキュメント
│   ├── guide.md
│   └── api-ref.md
└── scripts/           # オプション: 実行用スクリプト
    ├── analyze.py
    └── generate.py
```

### SKILL.md の構成

`SKILL.md`はスキルのエントリーポイントです。YAMLフロントマターとMarkdown本文で構成されます。

```markdown
---
name: pdf-processing
description: PDFファイルからテキストと表を抽出し、フォームに入力し、ドキュメントをマージします。PDFファイル、フォーム処理、またはデータ抽出について言及された場合に使用してください。
---

# PDF処理スキル

## 概要
このスキルはPDF操作のためのユーティリティを提供します。

## 使用方法
テキスト抽出には `pdfplumber` を使用してください：

\`\`\`python
import pdfplumber
with pdfplumber.open("file.pdf") as pdf:
    text = pdf.pages[0].extract_text()
\`\`\`

## 高度な機能
- **フォーム入力**: 手順については [pages/forms.md](pages/forms.md) を参照
- **APIリファレンス**: [pages/api-ref.md](pages/api-ref.md) を参照
```

#### YAMLフロントマター要件
- **name**: 
  - 最大64文字
  - 小文字、数字、ハイフンのみ (`a-z`, `0-9`, `-`)
  - 予約語（`anthropic`, `claude`）は禁止
  - XMLタグは禁止
- **description**:
  - 最大1024文字
  - 空であってはならない
  - スキルが**何をするか**だけでなく、**いつ使用すべきか**（トリガー）を含める
  - 三人称で記述する（例: 「Excelファイルを処理します」◎、「Excel処理をお手伝いできます」✕）

---

## 4. ベストプラクティス

高品質なスキルを作成するための重要な原則です。

### 命名規則
**動名詞形 (Verb + -ing)** を使用することで、機能が明確になります。
- 良い例: `processing-pdfs`, `analyzing-spreadsheets`, `testing-code`
- 悪い例: `helper`, `utils` (曖昧), `data`, `files` (一般的すぎる)

### 説明文 (Description) の書き方
Claudeが正しいスキルを選択できるかは `description` にかかっています。
- **具体的であること**: 主要なキーワードやライブラリ名を含める。
- **トリガーを含める**: 「〜したい場合に使用してください」と明記する。
- **例**: `git-commit-helper`
  > `git` の差分を分析して、説明的なコミットメッセージを生成します。ユーザーがコミットメッセージの作成またはステージされた変更のレビューを支援するよう求めている場合に使用してください。

### シンプルさと簡潔さ
- `SKILL.md` は **500行以下** に保つ。
- 長くなる場合は別ファイルに分割し、リンクする。
- "Claudeはすでに賢い" という前提で書く。Pythonの基本的な文法などを説明する必要はありません。

### 構造化のパターン
1. **参照パターン**: 詳細を別ファイル(`docs/advanced.md`など)に分け、`SKILL.md`からリンクする。
2. **ネストの深さ制限**: ファイル参照は **1レベル** に保つ。
   - 良い: `SKILL.md` -> `docs/detail.md`
   - 悪い: `SKILL.md` -> `docs/chapter1.md` -> `docs/section1.md` (Claudeが迷子になりやすい)
3. **ワークフローとチェックリスト**:
   - 複雑な作業はステップバイステップのチェックリスト形式にする。
   - Claudeに「このチェックリストをコピーして進捗を記録せよ」と指示すると効果的。

### フィードバックループ
「生成して終わり」ではなく、「生成 -> 検証 -> 修正」のループを組み込む。
- **例**: コードを生成した後、すぐに検証スクリプト (`validate.py`) を実行し、エラーがあれば修正する手順を明記する。

---

## 5. コーディングとスクリプト

スキル内でコードを実行する場合の注意点です。

### ユーティリティスクリプトの活用
Claudeにその場でコードを書かせるよりも、事前に用意した堅牢なスクリプト（`scripts/*.py`）を実行させる方が信頼性が高いです。
- **メリット**: トークン節約、エラー減少、一貫した動作。
- **指示の仕方**: 「コードを書いて実行して」ではなく、「`scripts/analyze.py` を実行して」と指示する。

### エラーハンドリング
スクリプト内ではエラーを握りつぶさず、Claudeが理解できるメッセージを出力して終了する（Fail loudly）。
- エラー時に「何が起きたか」「どうすれば直るか」を出力すると、Claudeが自律的に修正できる可能性が高まります。

### 環境の制約
- **ネットワークアクセスなし**: 外部APIは呼べません。
- **ファイルパス**: Windowsスタイルのバックスラッシュ（`\`）は避け、必ずフォワードスラッシュ（`/`）を使用する。
- **依存関係**: 必要なライブラリは明記する（`pip install`が必要な場合など）。ただし、環境によってはプリインストールされているものしか使えない場合もあるので注意。

---

## 6. APIとSDKでの使用方法

### SDK (Python/TypeScript) での使用
SDKでは、ローカルファイルシステムからスキルを読み込みます。

```python
from claude_agent_sdk import ClaudeAgentOptions

options = ClaudeAgentOptions(
    cwd="/path/to/project",             # .claude/skills フォルダを含む親ディレクトリ
    setting_sources=["user", "project"], # user(~/.claude/skills) と project(.claude/skills) を読み込む
    allowed_tools=["Skill", "bash", ...] # Skillツールを有効化
)
```
- **配置場所**: 
  - プロジェクト固有: `.claude/skills/`
  - ユーザー共通: `~/.claude/skills/`

### API での使用
APIリクエストの `container` パラメータでスキルを指定します。Anthropicのビルドインスキルとカスタムスキルが使用可能です。

```json
{
  "container": {
    "skills": [
      {
        "type": "anthropic",
        "skill_id": "pptx", // Excel(xlsx), Word(docx), PDF(pdf) もあり
        "version": "latest"
      },
      {
        "type": "custom",
        "skill_id": "YOUR_CUSTOM_SKILL_ID",
        "version": "latest"
      }
    ]
  },
  "tools": [
    { "type": "code_execution_20250825" } // コード実行ツールの有効化が必須
  ]
}
```

### 必須HTTPヘッダー (Beta)
- `code-execution-2025-08-25`: コード実行用
- `skills-2025-10-02`: スキル機能用
- `files-api-2025-04-14`: 生成ファイルのダウンロード用

---

## 7. テストと評価

スキルを作成する前に、評価基準（Evaluation）を作成することが推奨されます。

### テスト戦略
1. **モデル多様性**: Haiku（高速）、Sonnet（バランス）、Opus（推論）の各モデルで動作を確認する。
2. **スナックテスト**: 予想される質問を投げ、正しいスキルが呼び出されるか、指示通りに動くか確認する。
3. **観察と改善**: Claudeがどこでつまづくか（どのファイルを読むか、どの順序で実行するか）を観察し、`SKILL.md`の指示やリンク構造を調整する。

---

## 8. トラブルシューティング

- **スキルが読み込まれない**:
  - `setting_sources` に `"project"` や `"user"` が含まれているか確認。
  - ディレクトリ構造が `.claude/skills/スキル名/SKILL.md` になっているか確認。
- **誤ったスキルが使用される**:
  - `description` が曖昧でないか確認。キーワードを強化する。
- **ファイルが見つからないエラー**:
  - パスが間違っていないか。`reference/doc.md` のように相対パスで記述し、フォワードスラッシュを使用しているか。
- **APIエラー**:
  - 必要なBetaヘッダーがついているか確認。

---

## 9. 効果的なスキルのチェックリスト

スキルを完成させる前に、以下の項目を確認してください。

### 品質
- [ ] `description` は具体的で、トリガー条件を含んでいるか？
- [ ] `SKILL.md` は500行以下か？
- [ ] 用語は統一されているか？
- [ ] ファイル参照は深すぎないか（1レベル）？

### コード・実装
- [ ] スクリプトはエラー時に役立つメッセージを出すか？
- [ ] ファイルパスはフォワードスラッシュ（`/`）か？
- [ ] 重要な操作には検証ステップ（フィードバックループ）が含まれているか？
- [ ] 必要なパッケージ依存関係は明確か？

### テスト
- [ ] 複数のモデル（Sonnet, Haiku等）でテストしたか？
- [ ] 実際のユースケースで想定通り動作するか確認したか？

---
*詳細については、[公式ドキュメント](https://platform.claude.com/docs/ja/agents-and-tools/agent-skills/overview)および[Claude Skills Cookbook](https://github.com/anthropics/claude-cookbooks/tree/main/skills)を参照してください。*
